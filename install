#!/usr/bin/env bash
set -e

export LOG_FILE=/tmp/install.log
rm -f $LOG_FILE

echo -e "\nStarting \033[1mlamassu-server\033[0m install. This will take a few minutes...\n"

if [ "$(whoami)" != "root" ]; then
  echo -e "This script has to be run as \033[1mroot\033[0m user"
  exit 3
fi

IP=$(ifconfig eth0 | grep "inet addr" | awk -F: '{print $2}' | awk '{print $1}')
DOMAIN=$IP

echo "Updating system..."
curl -sL https://deb.nodesource.com/setup_6.x | sudo -E bash - >> $LOG_FILE 2>&1
add-apt-repository -y ppa:bitcoin/bitcoin >> $LOG_FILE 2>&1
add-apt-repository -y ppa:ethereum/ethereum >> $LOG_FILE 2>&1
apt update >> $LOG_FILE 2>&1

echo "Installing necessary packages..."
apt install nodejs python-minimal ethereum bitcoind build-essential postgresql libpq-dev -y -q >> $LOG_FILE 2>&1

echo "Generating seed..."
SEEDS_DIR=$HOME/seeds
SEED_FILE=$SEEDS_DIR/seed.txt
mkdir -p $SEEDS_DIR >> $LOG_FILE 2>&1
SEED=$(openssl rand -hex 32)
echo $SEED > $SEED_FILE

echo "Installing yarn package manager for node..."
npm -g --unsafe-perm install yarn

echo "Installing lamassu-server..."
yarn global add bunyan pm2 lamassu/lamassu-server#alpha \
  lamassu/lamassu-scripts#alpha \
  lamassu/lamassu-admin-server >> $LOG_FILE 2>&1

echo "Creating postgres user..."
POSTGRES_PW=$(hkdf postgres-pw $SEED)
su -l postgres >> $LOG_FILE 2>&1 <<EOF
  psql -c "CREATE ROLE lamassu_pg WITH LOGIN SUPERUSER PASSWORD '$POSTGRES_PW';"
  createdb lamassu
EOF


CERT_DIR=$HOME/certs
CONFIG_DIR=$HOME/.lamassu

mkdir -p $CERT_DIR >> $LOG_FILE 2>&1
mkdir -p $CONFIG_DIR >> $LOG_FILE 2>&1

echo "Generating SSL certificates..."

openssl genrsa \
  -out $CERT_DIR/root-ca.key.pem \
  4096

openssl req \
  -x509 \
  -new \
  -nodes \
  -key $CERT_DIR/root-ca.key.pem \
  -days 3560 \
  -out $CERT_DIR/root-ca.crt.pem \
  -subj "/C=IS/ST=/L=Reykjavik/O=Lamassu Operator CA/CN=lamassu-operator.is"

openssl genrsa \
  -out $CERT_DIR/server.key.pem \
  4096

openssl req -new \
  -key $CERT_DIR/server.key.pem \
  -out $CERT_DIR/server.csr.pem \
  -subj "/C=IS/ST=/L=Reykjavik/O=Lamassu Operator/CN=$DOMAIN"

# Sign the request from Device with your Root CA
openssl x509 \
  -req -in $CERT_DIR/server.csr.pem \
  -CA $CERT_DIR/root-ca.crt.pem \
  -CAkey $CERT_DIR/root-ca.key.pem \
  -CAcreateserial \
  -out $CERT_DIR/server.crt.pem \
  -days 3650

cat <<EOF > $CONFIG_DIR/lamassu.json
{
  "postgresql": "postgres://lamassu_pg:$POSTGRES_PW@localhost/lamassu",
  "seedPath": "$SEED_FILE",
  "logLevel": "debug"
}
EOF

lamassu-migrate >> $LOG_FILE 2>&1

echo "Installing lamassu-admin..."
lamassu-domain $DOMAIN >> $LOG_FILE 2>&1
ADMIN_REGISTRATION_URL=`lamassu-register admin 2>> $LOG_FILE`

echo "Starting lamassu-admin..."
pm2 start lamassu-admin-server --env '{"NODE_ENV": "production"}' >> $LOG_FILE 2>&1
pm2 start lamassu-server --env '{"NODE_ENV": "production"}' --restart-delay 10000 >> $LOG_FILE 2>&1
pm2 save >> $LOG_FILE 2>&1
pm2 startup >> $LOG_FILE 2>&1

echo "Setting up backups..."
BIN=$(npm -g bin)
BACKUP_DIR=$HOME/backups/postgresql
mkdir -p $BACKUP_DIR
chown root:postgres $BACKUP_DIR >> $LOG_FILE 2>&1
chmod 664 $BACKUP_DIR >> $LOG_FILE 2>&1
BACKUP_CRON="@daily $BIN/backup-pg > /dev/null"
echo $BACKUP_CRON | crontab -u postgres - >> $LOG_FILE 2>&1
backup-pg >> $LOG_FILE 2>&1

echo "Setting up firewall..."
ufw allow ssh >> $LOG_FILE 2>&1
ufw allow 443/tcp >> $LOG_FILE 2>&1  # Admin
ufw allow 3000/tcp >> $LOG_FILE 2>&1  # Server
ufw -f enable >> $LOG_FILE 2>&1

echo
echo "Done! Now it's time to configure Lamassu stack."
echo
echo "Activation URL for lamassu-admin:"
echo $ADMIN_REGISTRATION_URL
echo
echo "Please write this down in a safe place."
echo -e "\n*** IMPORTANT ***"
echo "Backup the contents of $SEED_FILE in a safe place."
echo "This seed will allow you to retrieve system passwords, including "
echo "the keys to your Ethereum accounts."
echo
