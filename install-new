#!/usr/bin/env bash
set -e

LOG_FILE=/tmp/install.log

function prompt() {
  question="$1"
  default="$2"
  silent="$3"
  var="$4"

  echo -n "$question: "
  if [ ! -z "$default" ]; then
    echo -n "($default) "
  fi

  if [ "$silent" = true ]; then
    read -s result
    echo
  else
    read result
  fi

  if [ -z "$result" ]; then
    export "$var=$default"
  else
    export "$var=$result"
  fi
}

rm -f $LOG_FILE

echo -e "\nStarting \033[1mlamassu-server\033[0m install.\n"

echo "Pick your admin panel credentials:"
prompt "Username" "admin" false admin_username
prompt "Password" "" true admin_password

echo
echo "Starting installation, this will take a few minutes..."
echo "Updating system..."
add-apt-repository -y ppa:ethereum/ethereum >> $LOG_FILE 2>&1
apt-get update -q >> $LOG_FILE 2>&1
echo "Installing necessary packages..."
apt-get install npm python-minimal ethereum build-essential -y -q >> $LOG_FILE 2>&1
echo "Installing n..."
npm install -g n >> $LOG_FILE 2>&1
echo "Upgrading nodejs..."
n lts >> $LOG_FILE 2>&1
echo "Installing postgresql..."
apt-get install postgresql -y -q >> $LOG_FILE 2>&1
echo "Creating DB..."
password=$(openssl rand -hex 32)
echo "{\"postgresql\":\"postgres://lamassu:$password@localhost/lamassu\"}" > /etc/lamassu.json
su - postgres >> $LOG_FILE 2>&1 <<EOF
  psql -c "CREATE ROLE lamassu WITH LOGIN SUPERUSER PASSWORD '$password';"
  createdb lamassu
EOF
echo "Installing lamassu-server..."
mkdir -p /opt/apps/node_modules
cd /opt/apps
npm install lamassu-server@beta >> $LOG_FILE 2>&1
npm install lamassu-scripts -g >> $LOG_FILE 2>&1
npm install bunyan migrate -g >> $LOG_FILE 2>&1
echo "Upgrading db schema..."
cd node_modules/lamassu-server
../migrate/bin/migrate >> $LOG_FILE 2>&1
echo "Installing lamassu-admin..."
npm install lamassu-admin >> $LOG_FILE 2>&1
lamassu-useradd "$admin_username" "$admin_password"
echo "Generating SSL certificates..."
ip=$(ifconfig eth0 | grep "inet addr" | awk -F: '{print $2}' | awk '{print $1}')
openssl req -new -newkey rsa:4096 -days 9999 -nodes -x509 -subj "/C=US/ST=/L=/O=/CN=$ip:8081" -keyout /root/lamassu-admin.key  -out /root/lamassu-admin.crt >> $LOG_FILE 2>&1
openssl req -new -newkey rsa:4096 -days 9999 -nodes -x509 -subj "/C=US/ST=/L=/O=/CN=$ip:3000" -keyout /root/lamassu-server.key -out /root/lamassu-server.crt >> $LOG_FILE 2>&1

echo
echo "Done! Now it's time to configure Lamassu stack."
echo "Open https://$ip:8081 in your browser to access "
echo "your admin panel."
